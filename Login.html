<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÇ‡∏´‡∏•‡∏î LIFF SDK ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card { 
            border: none; 
            border-radius: 1rem; 
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .logo-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        .military-badge {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: transform 0.3s ease;
        }
        .military-badge:hover {
            transform: scale(1.05);
        }
        .btn-military {
            background: linear-gradient(45deg, #2E8B57, #228B22);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-military:hover:not(:disabled) {
            background: linear-gradient(45deg, #228B22, #1F5F3F);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
        }
        .btn-military:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }
        .status-message {
            border-radius: 0.5rem;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #qr-reader {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: #000;
        }
        #qr-reader video {
            border-radius: 0.75rem;
        }
        .unit-info {
            background: linear-gradient(135deg, rgba(46, 139, 87, 0.1), rgba(34, 139, 34, 0.05));
            border: 1px solid rgba(46, 139, 87, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
            color: #2E8B57;
            font-weight: 600;
        }
        .mode-toggle {
            background: rgba(108, 117, 125, 0.1);
            border: 1px solid rgba(108, 117, 125, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        .debug-info {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: #0d6efd;
            max-height: 150px;
            overflow-y: auto;
        }
        .input-group {
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .demo-code {
            transition: all 0.2s ease;
        }
        .demo-code:hover {
            transform: scale(1.05);
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .online {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }
        .offline {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }
        .liff-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: #856404;
        }
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° profile section */
        .profile-section {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .profile-picture {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #28a745;
            margin: 0 auto 0.5rem;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status d-none">
        <i class="bi bi-wifi"></i> <span id="connectionText">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
    </div>

    <div class="container d-flex align-items-center justify-content-center min-vh-100 py-3">
        <div class="col-lg-6 col-md-8 col-sm-10">
            <div class="card shadow-lg">
                <div class="card-body p-4 p-lg-5">
                    <div class="logo-section">
                        <div class="military-badge">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <h3 class="text-primary mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
                        <div class="unit-info">
                            üéñÔ∏è ‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5 ‡∏û‡∏±‡∏ô.5<br>
                            üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏™‡∏î‡∏∏
                        </div>
                    </div>
                    
                    <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° LIFF Profile Display -->
                    <div id="profile-section" class="profile-section d-none">
                        <img id="pictureUrl" class="profile-picture" src="" alt="Profile Picture">
                        <div class="fw-bold text-success" id="displayName">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö </div>
                        <small class="text-muted" id="statusMessage"></small>
                        <div class="mt-2">
                            <small class="text-muted">USER ID: </small>
                            <small class="text-primary" id="userId"></small>
                        </div>
                        <div>
                            <small class="text-muted">EMAIL: </small>
                            <small class="text-info" id="decodedIDToken"></small>
                        </div>
                    </div>
                    
                    <!-- LIFF Warning -->
                    <div id="liff-warning" class="liff-warning d-none">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï LIFF ID</h6>
                        <p class="mb-0">
                            <small>
                                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á LINE Login Channel ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï LIFF_ID ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î<br>
                                <strong>‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <code id="current-liff-id"></code>
                            </small>
                        </p>
                    </div>
                    
                    <!-- Mode Selection -->
                    <div class="mode-toggle">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="demoMode" checked>
                            <label class="form-check-label" for="demoMode">
                                <i class="bi bi-gear"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Demo Mode)
                            </label>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤<br>
                            ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Google Apps Script ‡πÅ‡∏•‡∏∞ LINE LIFF
                        </small>
                    </div>
                    
                    <div id="status" class="mb-3 text-center" style="min-height: 50px;"></div>
                    
                    <!-- QR Scanner Section -->
                    <div id="scanner-view" class="d-none mb-3">
                        <div class="text-center mb-3">
                            <h5 class="text-success">üì± ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h5>
                            <small class="text-muted">‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ QR ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö</small>
                        </div>
                        <div id="qr-reader"></div>
                        <div class="text-center mt-3">
                            <button id="stopScanButton" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡πÅ‡∏Å‡∏ô
                            </button>
                        </div>
                    </div>
                    
                    <!-- Main Controls -->
                    <div id="main-controls">
                        <div class="d-grid gap-3">
                            <button id="scanButton" class="btn btn-military btn-lg">
                                <i class="bi bi-qr-code-scan me-2"></i> ‡∏™‡πÅ‡∏Å‡∏ô QR Code
                            </button>
                            
                            <div class="text-center">
                                <small class="text-muted">‡∏´‡∏£‡∏∑‡∏≠</small>
                            </div>
                            
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bi bi-key-fill text-warning"></i>
                                </span>
                                <input 
                                    type="password" 
                                    class="form-control border-0" 
                                    id="secretInput" 
                                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö"
                                    autocomplete="off"
                                >
                                <button class="btn btn-primary border-0" type="button" id="manualLogin">
                                    <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                                    <span class="button-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                                </button>
                            </div>
                            
                            <!-- Demo Credentials -->
                            <div id="demo-helper" class="alert alert-info">
                                <h6><i class="bi bi-info-circle me-2"></i> ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h6>
                                <div class="d-flex gap-2 flex-wrap justify-content-center">
                                    <button class="btn btn-sm btn-outline-primary demo-code" data-code="ADMIN2024">
                                        <i class="bi bi-person-gear me-1"></i> ADMIN2024
                                    </button>
                                    <button class="btn btn-sm btn-outline-success demo-code" data-code="STAFF001">
                                        <i class="bi bi-person-badge me-1"></i> STAFF001
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning demo-code" data-code="MANAGER">
                                        <i class="bi bi-person-star me-1"></i> MANAGER
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i> 
                                    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Information -->
                    <div id="debug-info" class="debug-info d-none">
                        <div class="d-flex align-items-center mb-2">
                            <strong><i class="bi bi-bug me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏ö‡∏±‡∏Å:</strong>
                            <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="clearDebugInfo()">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                        <div id="debug-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á LINE Login Channel
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzFzCjY8nrJSLf6EyhtV-p17xgbi8HbN7cjPxOKy9NzdGhIANVKZv7wBD5CBc9mxx51bg/exec";
        const LIFF_ID = "2007933662-G8KxppnN"; // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å LINE Login Channel

        // Global variables
        let isProcessing = false;
        let userId = null;
        let userName = null;
        let html5QrCode = null;
        let isDemoMode = true;
        let debugMessages = [];
        let userProfile = null; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ profile

        // Valid demo credentials with more realistic data
        const DEMO_CREDENTIALS = {
            'ADMIN2024': { 
                role: 'admin', 
                name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 
                unit: '‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5 ‡∏û‡∏±‡∏ô.5',
                permissions: ['read', 'write', 'admin', 'reports']
            },
            'STAFF001': { 
                role: 'staff', 
                name: '‡∏à.‡∏™.‡∏≠.‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', 
                unit: '‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5 ‡∏û‡∏±‡∏ô.5',
                permissions: ['read', 'write']
            },
            'MANAGER': { 
                role: 'manager', 
                name: '‡∏£.‡∏ï.‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', 
                unit: '‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5 ‡∏û‡∏±‡∏ô.5',
                permissions: ['read', 'write', 'manage', 'reports']
            },
            'BATTALION_XYZ_GUARD_POST_LOGIN_SECRET_2025': {
                role: 'superadmin',
                name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î',
                unit: '‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5 ‡∏û‡∏±‡∏ô.5',
                permissions: ['read', 'write', 'admin', 'reports', 'superadmin']
            }
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', main);

        // Network status monitoring
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏ß‡∏° LIFF functions
        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                userProfile = profile;
                userId = profile.userId;
                userName = profile.displayName;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• profile
                document.getElementById("pictureUrl").src = profile.pictureUrl;
                document.getElementById("userId").textContent = profile.userId.substring(0, 15) + '...';
                document.getElementById("statusMessage").textContent = profile.statusMessage || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
                document.getElementById("displayName").textContent = '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + profile.displayName;
                
                // Get ID Token for email
                try {
                    const idToken = liff.getDecodedIDToken();
                    document.getElementById("decodedIDToken").textContent = idToken.email || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• email';
                } catch (e) {
                    document.getElementById("decodedIDToken").textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á email ‡πÑ‡∏î‡πâ';
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á profile section
                document.getElementById("profile-section").classList.remove('d-none');
                
                addDebugMessage(`‚úÖ Profile loaded: ${profile.displayName}`);
                return profile;
            } catch (error) {
                console.error('Error getting profile:', error);
                addDebugMessage(`‚ùå Profile error: ${error.message}`);
                throw error;
            }
        }

        async function main() {
            console.log('üöÄ Starting Login System...');
            addDebugMessage('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
            
            // Check if LIFF_ID needs updating
            checkLiffConfiguration();
            
            // Initialize controls first
            initializeControls();
            updateNetworkStatus();
            
            // Check demo mode
            isDemoMode = document.getElementById('demoMode').checked;
            updateDemoMode();
            
            if (isDemoMode) {
                showStatus('‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö)', 'success');
                addDebugMessage('‚úÖ ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            // Check if LIFF is available
            if (typeof liff === 'undefined') {
                showStatus('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö LINE LIFF SDK<br><small class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE</small>', 'warning');
                addDebugMessage('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö LINE LIFF SDK');
                return;
            }

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ LIFF function ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            await initializeLIFF();
        }

        function checkLiffConfiguration() {
            if (LIFF_ID.includes('NEW_')) {
                const liffWarning = document.getElementById('liff-warning');
                const currentLiffId = document.getElementById('current-liff-id');
                
                if (liffWarning && currentLiffId) {
                    liffWarning.classList.remove('d-none');
                    currentLiffId.textContent = LIFF_ID;
                    addDebugMessage('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï LIFF_ID');
                }
            } else {
                addDebugMessage('‚úÖ LIFF_ID ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        async function initializeLIFF() {
            showStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...', 'info');
            addDebugMessage('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF...');
            
            try {
                if (!LIFF_ID || LIFF_ID.trim() === "" || LIFF_ID.includes('NEW_')) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï LIFF_ID ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á LINE Login Channel ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                }

                console.log('Initializing LIFF with ID:', LIFF_ID);
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° withLoginOnExternalBrowser option
                await liff.init({ 
                    liffId: LIFF_ID, 
                    withLoginOnExternalBrowser: true 
                });
                
                addDebugMessage(`‚úÖ LIFF ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>URL: ${window.location.href}<br>isInClient: ${liff.isInClient()}<br>OS: ${liff.getOS()}`);

                // Check login status
                if (!liff.isLoggedIn()) {
                    console.log('User not logged in, redirecting to LINE login...');
                    showStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...', 'info');
                    addDebugMessage('üîÑ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE');
                    liff.login({ redirectUri: window.location.href });
                    return;
                }
                
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ getUserProfile function
                await getUserProfile();
                
                console.log('User logged in:', { userId: userId.substring(0, 10) + '...', userName });
                addDebugMessage(`‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${userName}<br>ID: ${userId.substring(0, 10)}...`);
                
                showStatus(`‚úÖ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${userName}`, 'success');
                
            } catch (err) {
                console.error("‚ùå LIFF Init Error:", err);
                addDebugMessage(`‚ùå LIFF Error: ${err.message}`);
                showStatus(
                    `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ<br>` +
                    `<small class="text-muted">${err.message}<br>` +
                    `‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</small>`, 
                    'warning'
                );
            }
        }
        
        function initializeControls() {
            try {
                console.log('üîß Initializing controls...');
                
                // Get elements with error checking
                const elements = {
                    scanButton: document.getElementById('scanButton'),
                    stopScanButton: document.getElementById('stopScanButton'),
                    manualLoginButton: document.getElementById('manualLogin'),
                    secretInput: document.getElementById('secretInput'),
                    demoModeToggle: document.getElementById('demoMode'),
                    demoCodes: document.querySelectorAll('.demo-code')
                };

                // Check if all elements exist
                Object.entries(elements).forEach(([name, element]) => {
                    if (!element) {
                        console.error(`Element ${name} not found`);
                    }
                });
                
                // Add event listeners with null checks
                if (elements.scanButton) {
                    elements.scanButton.addEventListener('click', startScan);
                }
                
                if (elements.stopScanButton) {
                    elements.stopScanButton.addEventListener('click', stopScan);
                }
                
                if (elements.manualLoginButton) {
                    elements.manualLoginButton.addEventListener('click', manualLogin);
                }
                
                if (elements.secretInput) {
                    elements.secretInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && !isProcessing) {
                            manualLogin();
                        }
                    });
                    
                    // Clear error status when typing
                    elements.secretInput.addEventListener('input', function() {
                        const status = document.getElementById('status');
                        if (status.innerHTML.includes('‚ùå') || status.innerHTML.includes('‚ö†Ô∏è')) {
                            showStatus('', '');
                        }
                    });
                }

                if (elements.demoModeToggle) {
                    elements.demoModeToggle.addEventListener('change', function() {
                        isDemoMode = this.checked;
                        updateDemoMode();
                        if (isDemoMode) {
                            showStatus('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'success', 3000);
                            addDebugMessage('üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                            // ‡∏ã‡πà‡∏≠‡∏ô profile section ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô demo mode
                            document.getElementById("profile-section").classList.add('d-none');
                        } else {
                            addDebugMessage('üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á');
                            initializeLIFF();
                        }
                    });
                }

                // Demo code buttons
                if (elements.demoCodes) {
                    elements.demoCodes.forEach(btn => {
                        btn.addEventListener('click', function() {
                            const code = this.dataset.code;
                            const input = document.getElementById('secretInput');
                            if (input) {
                                input.value = code;
                                input.focus();
                                // Auto login after short delay for better UX
                                setTimeout(() => manualLogin(), 500);
                            }
                        });
                    });
                }
                
                console.log('‚úÖ Controls initialized successfully');
                addDebugMessage('‚úÖ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch(err) {
                console.error("‚ùå Control Init Error:", err);
                addDebugMessage(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${err.message}`);
                showStatus('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö', 'danger');
            }
        }

        function updateDemoMode() {
            const demoHelper = document.getElementById('demo-helper');
            const debugInfo = document.getElementById('debug-info');
            
            if (isDemoMode) {
                demoHelper?.classList.remove('d-none');
                debugInfo?.classList.remove('d-none');
                addDebugMessage('üìã ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ LINE LIFF');
            } else {
                demoHelper?.classList.add('d-none');
                debugInfo?.classList.add('d-none');
            }
        }

        function updateNetworkStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (!statusElement || !textElement) return;
            
            if (navigator.onLine) {
                statusElement.className = 'connection-status online';
                textElement.innerHTML = '<i class="bi bi-wifi me-1"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                statusElement.classList.remove('d-none');
                setTimeout(() => statusElement.classList.add('d-none'), 3000);
            } else {
                statusElement.className = 'connection-status offline';
                textElement.innerHTML = '<i class="bi bi-wifi-off me-1"></i>‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                statusElement.classList.remove('d-none');
            }
        }

        function addDebugMessage(message) {
            const timestamp = new Date().toLocaleTimeString('th-TH');
            debugMessages.push(`[${timestamp}] ${message}`);
            
            // Keep only last 50 messages
            if (debugMessages.length > 50) {
                debugMessages.shift();
            }
            
            const debugText = document.getElementById('debug-text');
            if (debugText) {
                debugText.innerHTML = debugMessages.join('<br>');
                debugText.scrollTop = debugText.scrollHeight;
            }
        }

        function clearDebugInfo() {
            debugMessages = [];
            const debugText = document.getElementById('debug-text');
            if (debugText) {
                debugText.innerHTML = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß';
            }
        }

        async function startScan() {
            try {
                console.log('üì± Starting QR scan...');
                addDebugMessage('üì± ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô QR Code...');
                
                // Check camera permission first
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á');
                }

                // Initialize QR scanner if not exists
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }

                // Check if already scanning
                if (html5QrCode.isScanning) {
                    console.log('Already scanning, stopping first...');
                    await html5QrCode.stop();
                }
                
                // Hide main controls, show scanner
                const mainControls = document.getElementById('main-controls');
                const scannerView = document.getElementById('scanner-view');
                
                if (mainControls) mainControls.style.display = 'none';
                if (scannerView) scannerView.classList.remove('d-none');
                
                // Configure scanner with better settings
                const config = { 
                    fps: 10, 
                    qrbox: function(viewfinderWidth, viewfinderHeight) {
                        let minEdgePercentage = 0.7;
                        let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                        let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                        return {
                            width: qrboxSize,
                            height: qrboxSize
                        };
                    },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                const successCallback = (decodedText, decodedResult) => {
                    console.log('‚úÖ QR Code scanned:', decodedText.substring(0, 20) + '...');
                    addDebugMessage(`‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ: ${decodedText.substring(0, 30)}...`);
                    stopScan().then(() => processLogin(decodedText));
                };
                
                const errorCallback = (errorMessage) => {
                    // Silent error handling for continuous scanning
                    // Only log significant errors
                    if (!errorMessage.includes('NotFoundException')) {
                        console.log('Scan error:', errorMessage);
                    }
                };
                
                // Start scanning with fallback cameras
                const cameras = await Html5Qrcode.getCameras();
                addDebugMessage(`üìπ ‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á ${cameras.length} ‡∏ï‡∏±‡∏ß`);
                
                if (cameras.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå');
                }

                // Try environment camera first (back camera)
                let cameraId = { facingMode: "environment" };
                
                // If multiple cameras, prefer back camera
                if (cameras.length > 1) {
                    const backCamera = cameras.find(camera => 
                        camera.label.toLowerCase().includes('back') ||
                        camera.label.toLowerCase().includes('rear') ||
                        camera.label.toLowerCase().includes('environment')
                    );
                    if (backCamera) {
                        cameraId = backCamera.id;
                    }
                }
                
                await html5QrCode.start(
                    cameraId, 
                    config, 
                    successCallback,
                    errorCallback
                );
                
                showStatus('üì± ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR Code...', 'info');
                addDebugMessage('‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');
                
            } catch (err) {
                console.error('‚ùå Scan start error:', err);
                addDebugMessage(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô: ${err.message}`);
                
                let errorMessage = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
                if (err.message.includes('NotAllowedError') || err.message.includes('Permission')) {
                    errorMessage += '<br><small class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</small>';
                } else if (err.message.includes('NotFoundError')) {
                    errorMessage += '<br><small class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</small>';
                } else {
                    errorMessage += `<br><small class="text-muted">${err.message}</small>`;
                }
                
                showStatus(errorMessage, 'danger');
                stopScan();
            }
        }
        
        async function stopScan() {
            try {
                console.log('üõë Stopping QR scan...');
                addDebugMessage('üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô QR Code');
                
                if (html5QrCode && html5QrCode.isScanning) {
                    await html5QrCode.stop();
                }
            } catch (err) {
                console.log('Stop scan error (non-critical):', err);
                addDebugMessage(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô: ${err.message}`);
            } finally {
                // Always reset UI
                const scannerView = document.getElementById('scanner-view');
                const mainControls = document.getElementById('main-controls');
                
                if (scannerView) scannerView.classList.add('d-none');
                if (mainControls) mainControls.style.display = 'block';
            }
        }

        async function manualLogin() {
            const secretInput = document.getElementById('secretInput');
            if (!secretInput) {
                console.error('Secret input not found');
                return;
            }
            
            const secret = secretInput.value.trim();
            
            if (!secret) {
                showStatus('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö', 'warning', 3000);
                secretInput.focus();
                return;
            }
            
            await processLogin(secret);
        }

        async function processLogin(secret) {
            if (isProcessing) {
                console.log('‚è∏Ô∏è Login already processing');
                return;
            }
            
            if (!navigator.onLine && !isDemoMode) {
                showStatus('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'danger');
                addDebugMessage('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
                return;
            }
            
            console.log('üîê Processing login...');
            addDebugMessage('üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö...');
            isProcessing = true;
            toggleSpinner(true);
            showStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...', 'info');
            
            try {
                if (isDemoMode) {
                    // Demo mode - check against local credentials
                    addDebugMessage('üß™ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                    
                    if (DEMO_CREDENTIALS[secret]) {
                        const user = DEMO_CREDENTIALS[secret];
                        addDebugMessage(`‚úÖ ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.name} (${user.role})`);
                        
                        showStatus(
                            `‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö)<br>` +
                            `<small class="text-success">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${user.name}</small><br>` +
                            `<small class="text-muted">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${user.unit}</small>`, 
                            'success'
                        );
                        
                        addDebugMessage(`üìä ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${user.permissions.join(', ')}`);
                        
                        // Clear input on success
                        document.getElementById('secretInput').value = '';
                        
                        // Simulate successful login flow
                        setTimeout(() => {
                            showStatus('üö™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å...', 'info');
                            addDebugMessage('üö™ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å');
                        }, 2000);
                        
                        setTimeout(() => {
                            showStatus('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                            addDebugMessage('‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                        }, 3500);
                        
                    } else {
                        addDebugMessage(`‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${secret.substring(0, 10)}...`);
                        showStatus('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'danger');
                        document.getElementById('secretInput').value = '';
                        document.getElementById('secretInput').focus();
                    }
                    
                } else {
                    // Real mode - send to Google Apps Script
                    addDebugMessage('üåê ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
                    
                    if (!WEB_APP_URL || WEB_APP_URL.trim() === "") {
                        addDebugMessage('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö WEB_APP_URL - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                        showStatus(
                            '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå<br>' +
                            '<small class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</small>',
                            'warning'
                        );
                        return;
                    }
                    
                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• profile ‡πÉ‡∏ô request
                    const requestData = {
                        action: 'processAdminLogin',
                        secret: secret,
                        userId: userId || 'no-user-id',
                        userName: userName || 'unknown',
                        userProfile: userProfile || null,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent.substring(0, 100),
                        liffId: LIFF_ID
                    };
                    
                    console.log('üì§ Sending login request:', { 
                        action: requestData.action, 
                        userId: userId ? userId.substring(0, 10) + '...' : 'none',
                        userName: userName,
                        timestamp: requestData.timestamp,
                        liffId: LIFF_ID
                    });
                    
                    addDebugMessage(`üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${JSON.stringify({
                        action: requestData.action,
                        hasUserId: !!userId,
                        userName: userName,
                        timestamp: requestData.timestamp,
                        liffId: LIFF_ID
                    })}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestData),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log('üì• Response status:', response.status);
                    addDebugMessage(`üì• ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    addDebugMessage(`üìÑ Content-Type: ${contentType}`);
                    
                    let result;
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        addDebugMessage(`üìÑ Response text: ${text.substring(0, 200)}...`);
                        throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    }
                    
                    console.log('üìÑ Login result:', result);
                    addDebugMessage(`üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${JSON.stringify(result)}`);
                    
                    if (result.status === 'success') {
                        showStatus(
                            `‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>` +
                            `<small class="text-success">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${userName || result.userName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</small>`, 
                            'success'
                        );
                        
                        addDebugMessage('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á');
                        
                        // Clear input on success
                        document.getElementById('secretInput').value = '';
                        
                        // Close LIFF window after success
                        setTimeout(() => {
                            console.log('üö™ Closing LIFF window...');
                            addDebugMessage('üö™ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF');
                            
                            if (typeof liff !== 'undefined' && liff.isInClient()) {
                                liff.closeWindow();
                            } else {
                                showStatus('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ', 'success');
                                // Try to close window
                                try {
                                    window.close();
                                } catch (e) {
                                    console.log('Cannot close window automatically');
                                }
                            }
                        }, 2000);
                        
                    } else {
                        const errorMsg = result.message || '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
                        addDebugMessage(`‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${errorMsg}`);
                        showStatus(`‚ùå ${errorMsg}`, 'danger');
                        document.getElementById('secretInput').value = '';
                        document.getElementById('secretInput').focus();
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Login error:', error);
                addDebugMessage(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                
                let errorMessage = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                
                if (error.name === 'AbortError') {
                    errorMessage = '‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
                } else if (error.message.includes('NetworkError')) {
                    errorMessage = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢';
                }
                
                showStatus(
                    `${errorMessage}<br>` +
                    `<small class="text-muted">${error.message}</small>`, 
                    'danger'
                );
                
            } finally {
                isProcessing = false;
                toggleSpinner(false);
                
                // Auto-focus input on failure (not success)
                if (!document.getElementById('status').innerHTML.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) {
                    const secretInput = document.getElementById('secretInput');
                    if (secretInput) {
                        setTimeout(() => secretInput.focus(), 100);
                    }
                }
            }
        }
        
        function showStatus(message, type, duration = 0) {
            const statusBox = document.getElementById('status');
            if (!statusBox) return;
            
            if (!message) {
                statusBox.innerHTML = '';
                return;
            }
            
            const alertClass = `alert alert-${type} status-message mb-0`;
            statusBox.innerHTML = `<div class="${alertClass}">${message}</div>`;
            
            if (duration > 0) {
                setTimeout(() => {
                    if (statusBox.innerHTML.includes(message)) {
                        statusBox.innerHTML = '';
                    }
                }, duration);
            }
        }
        
        function toggleSpinner(show) {
            const spinner = document.querySelector('#manualLogin .spinner-border');
            const buttonText = document.querySelector('#manualLogin .button-text');
            const manualBtn = document.getElementById('manualLogin');
            const scanBtn = document.getElementById('scanButton');
            const secretInput = document.getElementById('secretInput');
            const demoCodes = document.querySelectorAll('.demo-code');
            
            if (spinner) spinner.classList.toggle('d-none', !show);
            if (buttonText) buttonText.textContent = show ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö';
            if (manualBtn) manualBtn.disabled = show;
            if (scanBtn) scanBtn.disabled = show;
            if (secretInput) secretInput.disabled = show;
            
            // Disable demo code buttons
            demoCodes.forEach(btn => btn.disabled = show);
        }
        
        // Add global error handlers
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            addDebugMessage(`‚ùå Global Error: ${e.error?.message || 'Unknown error'}`);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            addDebugMessage(`‚ùå Promise Rejection: ${e.reason?.message || 'Unknown rejection'}`);
        });

        // Prevent form submission on Enter
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
            }
        });

        // Add visibility change handler to stop camera when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && html5QrCode && html5QrCode.isScanning) {
                stopScan();
                addDebugMessage('üì± ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô');
            }
        });

        // Add beforeunload handler to clean up camera
        window.addEventListener('beforeunload', function() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(() => {});
            }
        });
    </script>
</body>
</html>
